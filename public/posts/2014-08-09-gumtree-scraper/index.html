<!DOCTYPE html>
<html lang="en-us"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>
    










  



  
  

<link rel="stylesheet" href="https://cb-com-new.vercel.app/scss/main.min.css" />


    

    

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>

  </head><body>
    <header class="container">
    <nav class="main-nav" id="js-navbar">
      <a class="logo" href="https://cb-com-new.vercel.app/">Clinton Boys</a>
      <ul class="menu" id="js-menu">
        
        
        
          <li class="menu-item">
            <a href="/about/" class="menu-link">About</a>
          </li>
        
        
        
          <li class="menu-item">
            <a href="/now/" class="menu-link">Now</a>
          </li>
        
        
        
          <li class="menu-item">
            <a href="/posts/" class="menu-link">Writing</a>
          </li>
        
        
        
          <li class="menu-item">
            <a href="/projects/" class="menu-link">Projects</a>
          </li>
        
        
        
          <li class="menu-item">
            <a href="http://mtsolitary.com" class="menu-link">Notes</a>
          </li>
        
        
        <li class="menu-item--align">
          <div class="switch">
            <input class="switch-input" type="checkbox" id="themeSwitch">
            <label aria-hidden="true" class="switch-label" for="themeSwitch">On</label>
            <div aria-hidden="true" class="switch-marker"></div>
          </div>
        </li>
      </ul>
      <span class="nav-toggle" id="js-navbar-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" id="Outline" viewBox="0 0 24 24" width="30" height="30" fill="var(--color-contrast-high)"><rect y="11" width="24" height="2" rx="1"/><rect y="4" width="24" height="2" rx="1"/><rect y="18" width="24" height="2" rx="1"/></svg>
      </span>
    </nav>
  </header>
<main class="section">
<div class="single-container-post">
  

  <div class="single-post-contents">
    <div class="single-feature-img">




  


<div class="feature-image-wrap">
<img class="feature-image" 
     srcset="/posts/2014-08-09-gumtree-scraper/sample-image-9.jpg 480w, /posts/2014-08-09-gumtree-scraper/sample-image-9.jpg 800w"
     sizes="(max-width: 600px) 480px, 800px"
     src="/posts/2014-08-09-gumtree-scraper/sample-image-9.jpg"
     alt="Cascade Mountains, Oregon, USA, 2013">
     <div class="feature-image-text">Cascade Mountains, Oregon, USA, 2013</div>
    </div>
</div>
    <article class="markdown">
        <h1 id="scraping-gumtree"></h>Scraping Gumtree<a href="#scraping-gumtree">
    
  </a>
</h1><p><em>September 8, 2014</em></p>
<h2 id="introduction"></h>Introduction<a href="#introduction">
    
  </a>
</h2><p>Gumtree.com.au is a trading post website, largely used by private sellers interacting with each other off-site to sell used goods. One particularly common use for Gumtree is concert tickets: this is one of the main uses I have for it.</p>
<p>The site is however fairly lightweight, and doesn&rsquo;t have any sort of notifications system for a particular search. So when looking for tickets to a particular concert, say, you have to search the site constantly and see if there are any new results.</p>
<p>I decided to learn some basic web-scraping techniques to write a script that did all this work for me. I wanted the following features:</p>
<ol>
<li>To specify a keyword (e.g. &ldquo;arctic monkeys&rdquo;).</li>
<li>To have the script crawl Gumtree every \(x\) minutes.</li>
<li>To email me with any new results (within particular geographic areas or price brackets).</li>
</ol>
<h2 id="web-scraping"></h>Web scraping<a href="#web-scraping">
    
  </a>
</h2><p>I&rsquo;d not done much web scraping before but I&rsquo;d heard good things about BeautifulSoup in Python to parse the scraped html, together with the requests package to actually scrape the pages. Since I was looking for tickets to a particular show, I used the following parameters, which could of course be altered depending on the user&rsquo;s requirements:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>    <span style="color:#a6e22e">artist</span>=<span style="color:#e6db74">&#34;arctic+monkeys&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    <span style="color:#a6e22e">city</span>=<span style="color:#e6db74">&#34;sydney&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    <span style="color:#a6e22e">URL_START</span>=<span style="color:#e6db74">&#39;http://www.gumtree.com.au&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    <span style="color:#a6e22e">OFFER_CHOICE</span>=[<span style="color:#e6db74">&#39;k0?ad=offering&#39;</span>,<span style="color:#e6db74">&#39;k0?ad=wanted&#39;</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    <span style="color:#a6e22e">ARTIST_URL</span>=<span style="color:#e6db74">&#34;arctic+monkeys&#34;</span><span style="color:#75715e">#re.sub(&#34;\s&#34;,+,artist)</span></span></span></code></pre></div>
<p>I then used the requests package to scrape a gumtree results page and dump the JSON output; this scrapes the $n$th result page (Gumtree limits to 10 results per page).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">scrape_gumtree_page_n</span>(n):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    current_time<span style="color:#f92672">=</span>int(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    pageURL<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">/s-</span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">+</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">/page-</span><span style="color:#e6db74">{3}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{4}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(URL_START,ARTIST_URL,city,n,OFFER_CHOICE[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    savePath<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(scrapings_dir,<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">.html&#34;</span><span style="color:#f92672">.</span>format(current_time))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    results<span style="color:#f92672">=</span>requests<span style="color:#f92672">.</span>get(pageURL)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>    results_file<span style="color:#f92672">=</span>open(savePath,<span style="color:#e6db74">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>    <span style="color:#66d9ef">with</span> results_file:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>        results_file<span style="color:#f92672">.</span>write(results<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>,errors<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ignore&#39;</span>))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span><span>    <span style="color:#66d9ef">return</span> savePath</span></span></code></pre></div>
<p>There was then a simple while loop to run this over all results pages.</p>
<h3 id="parsing-json-using-beautifulsoup"></h>Parsing JSON using BeautifulSoup<a href="#parsing-json-using-beautifulsoup">
    
  </a>
</h3><p>Having obtained a whole bunch of messy output from the scraper, I used the following code to parse using BeautifulSoup:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">html_parser</span>(filename):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    gumtree_file<span style="color:#f92672">=</span>open(filename)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    gumtree_contents<span style="color:#f92672">=</span>gumtree_file<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    gtsoup<span style="color:#f92672">=</span>BeautifulSoup(gumtree_contents)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    master_list<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    gt_li<span style="color:#f92672">=</span>gtsoup<span style="color:#f92672">.</span>findAll(<span style="color:#e6db74">&#39;li&#39;</span>, attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;class&#39;</span>: <span style="color:#e6db74">&#39;js-click-block&#39;</span>})
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    <span style="color:#66d9ef">for</span> node <span style="color:#f92672">in</span> gt_li:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>        <span style="color:#66d9ef">if</span> len(node<span style="color:#f92672">.</span>contents) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>            post_dict<span style="color:#f92672">=</span>{}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>            <span style="color:#66d9ef">if</span> node<span style="color:#f92672">.</span>findAll(<span style="color:#e6db74">&#39;a&#39;</span>) <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                post_dict[<span style="color:#e6db74">&#39;title&#39;</span>]<span style="color:#f92672">=</span>node<span style="color:#f92672">.</span>findAll(<span style="color:#e6db74">&#39;a&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>string
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>            <span style="color:#66d9ef">if</span> node<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;div&#39;</span>,attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;class&#34;</span>:<span style="color:#e6db74">&#34;h-elips&#34;</span>}) <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>                post_dict[<span style="color:#e6db74">&#39;price&#39;</span>]<span style="color:#f92672">=</span>node<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;div&#39;</span>,attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;class&#34;</span>:<span style="color:#e6db74">&#34;h-elips&#34;</span>})<span style="color:#f92672">.</span>string
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>            <span style="color:#66d9ef">if</span> node<span style="color:#f92672">.</span>findAll(<span style="color:#e6db74">&#39;span&#39;</span>) <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                post_dict[<span style="color:#e6db74">&#39;description&#39;</span>]<span style="color:#f92672">=</span>node<span style="color:#f92672">.</span>findAll(<span style="color:#e6db74">&#39;span&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>            <span style="color:#66d9ef">if</span> node<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;h3&#39;</span>,attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;class&#34;</span>:<span style="color:#e6db74">&#34;rs-ad-location&#34;</span>}) <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                post_dict[<span style="color:#e6db74">&#39;location1&#39;</span>]<span style="color:#f92672">=</span>node<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;h3&#39;</span>,attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;class&#34;</span>:<span style="color:#e6db74">&#34;rs-ad-location-area&#34;</span>})<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>            <span style="color:#66d9ef">if</span> node<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;span&#39;</span>,attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;class&#34;</span>:<span style="color:#e6db74">&#34;rs-ad-location-suburb&#34;</span>}) <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>                post_dict[<span style="color:#e6db74">&#39;location2&#39;</span>]<span style="color:#f92672">=</span>node<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;span&#39;</span>,attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;class&#34;</span>:<span style="color:#e6db74">&#34;rs-ad-location-suburb&#34;</span>})<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>            <span style="color:#66d9ef">if</span> node<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;div&#39;</span>,attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;class&#34;</span>:<span style="color:#e6db74">&#34;rs-ad-date&#34;</span>}) <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                post_dict[<span style="color:#e6db74">&#39;date&#39;</span>]<span style="color:#f92672">=</span>node<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;div&#39;</span>,attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;class&#34;</span>:<span style="color:#e6db74">&#34;rs-ad-date&#34;</span>})<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>            anchors<span style="color:#f92672">=</span>node<span style="color:#f92672">.</span>findAll(<span style="color:#e6db74">&#39;a&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>            <span style="color:#66d9ef">for</span> node <span style="color:#f92672">in</span> anchors:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>                <span style="color:#66d9ef">if</span> node<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;data-adid&#34;</span>) <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>                    post_dict[<span style="color:#e6db74">&#39;ad_id&#39;</span>]<span style="color:#f92672">=</span>node<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;data-adid&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>            master_list<span style="color:#f92672">.</span>append(post_dict)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>    <span style="color:#66d9ef">return</span> master_list</span></span></code></pre></div>
<p>This returned things like</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    <span style="color:#f92672">&#34;ad_id&#34;</span>: <span style="color:#e6db74">&#34;1048303295&#34;</span>, 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>	<span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;Selling: 2 Coldplay Tickets - Sydney 19 June &#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>	<span style="color:#f92672">&#34;title&#34;</span>: <span style="color:#66d9ef">null</span>, 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>	<span style="color:#f92672">&#34;price&#34;</span>: <span style="color:#e6db74">&#34;\n500&#34;</span>, 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>	<span style="color:#f92672">&#34;location2&#34;</span>: <span style="color:#e6db74">&#34;St Ives Chase&#34;</span>, 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>	<span style="color:#f92672">&#34;date&#34;</span>: <span style="color:#e6db74">&#34;\n04/06/2014&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>}</span></span></code></pre></div>
<p>which contains all the relevant information. This took me a while to write as I&rsquo;d not dealt with JSON much before, so I had to figure everything out from scratch. It was very satisfying to run the parser successfully and have big page-sized chunks of horrible JSON condensed into little search result nuggets like the above.</p>
<h3 id="mandrill-email-automation"></h>Mandrill email automation<a href="#mandrill-email-automation">
    
  </a>
</h3><p>I wanted to run the scraper constantly in the background, preferably on an Amazon Web Server instance, and have it send automated emails every time it found a new result. I had to register a Mandrill account to use their API; once an API key was generated I wrote the following very basic email template:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">new_result_email</span>(result,artist,city):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    subj<span style="color:#f92672">=</span>artist<span style="color:#f92672">+</span><span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">+</span>city
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    body<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>dumps(result)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    message <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        <span style="color:#e6db74">&#39;from_email&#39;</span>: <span style="color:#e6db74">&#39;...&#39;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        <span style="color:#e6db74">&#39;from_name&#39;</span>: <span style="color:#e6db74">&#39;Clinton Boys&#39;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        <span style="color:#e6db74">&#39;headers&#39;</span>: {<span style="color:#e6db74">&#39;Reply-To&#39;</span>: <span style="color:#e6db74">&#39;...&#39;</span>},
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>        <span style="color:#e6db74">&#39;important&#39;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#e6db74">&#39;preserve_recipients&#39;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#e6db74">&#39;return_path_domain&#39;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        <span style="color:#e6db74">&#39;signing_domain&#39;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        <span style="color:#e6db74">&#39;subject&#39;</span>: subj,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#e6db74">&#39;text&#39;</span>: body,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#e6db74">&#39;to&#39;</span>: [{<span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;...&#39;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                <span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Clinton Boys&#39;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                <span style="color:#e6db74">&#39;type&#39;</span>: <span style="color:#e6db74">&#39;to&#39;</span>}],
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    result <span style="color:#f92672">=</span> mandrill_client<span style="color:#f92672">.</span>messages<span style="color:#f92672">.</span>send(message<span style="color:#f92672">=</span>message)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>    print(result)</span></span></code></pre></div>
<p>which I called in my function &ldquo;regular_scraping&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">regular_scraping</span>():
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    json_file<span style="color:#f92672">=</span>open(<span style="color:#e6db74">&#39;master_file.text&#39;</span>,<span style="color:#e6db74">&#34;r&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    json_file_contents<span style="color:#f92672">=</span> json_file<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>stat(<span style="color:#e6db74">&#39;master_file.text&#39;</span>)[<span style="color:#ae81ff">6</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        old_data<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>loads(json_file_contents)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        old_data<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    this_scrape<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,pages_to_scrape()<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        this_scrape<span style="color:#f92672">.</span>append(html_parser(scrape_gumtree_page_n(n)))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        data_ids<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        new_entries<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        new_entry_count<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#66d9ef">for</span> entry <span style="color:#f92672">in</span> old_data:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>            data_ids<span style="color:#f92672">.</span>append(entry[<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;ad_id&#39;</span>])
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        <span style="color:#66d9ef">for</span> entry <span style="color:#f92672">in</span> this_scrape[n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>            <span style="color:#66d9ef">if</span> entry[<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;ad_id&#39;</span>] <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> data_ids:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>                old_data<span style="color:#f92672">.</span>append(entry)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>                new_entry_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>                new_entries<span style="color:#f92672">.</span>append(entry)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                new_result_email(entry,artist,city)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    json_file<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>    json_file<span style="color:#f92672">=</span>open(<span style="color:#e6db74">&#39;master_file.text&#39;</span>,<span style="color:#e6db74">&#34;w&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    json_file<span style="color:#f92672">.</span>write(json<span style="color:#f92672">.</span>dumps(old_data))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>    json_file<span style="color:#f92672">.</span>close()</span></span></code></pre></div>
<p>The last step was to set this up on an Amazon Web Server instance: I made a master file which put all these ingredients together: every \(x\) seconds (by default I chose 120), it ran the scraper across all results pages, looked through the neatened JSON for results, compared these to a master results file on disk, and if there were any new results, added to the file and sent an email through Mandrill. This was easy enough to set up, although there&rsquo;s still a bunch of memory leak issues because my code isn&rsquo;t great; after a while it will eventually crash the AWS instance. It did solve my initial problem though, which was the whole point of the exercise, and I did learn a whole lot of new techniques.</p>

    </article>
    <aside>
      <div class="single-terms">
        
      </div>
      
        

  
  

        
  <section>
    <h2>Read Next</h2>
    <div class="single-next-previous">
      
      
        <a class="next" href="https://cb-com-new.vercel.app/posts/israeli-poll-aggregator/">Aggregating Israeli opinion polls &raquo;</a>
      
    </div>
  </section>

      
    </aside>
  </div>
</div>

    </main><footer>
  
  <div class="section footer">
    <p class="footer-copyright"><i>&copy; 2014 - 2024
      Clinton Boys</i>
      
    </p>
    
  </div>
</footer>

  








  
  
    

<script src="https://cb-com-new.vercel.app/main.min.js"></script>



  
</body>
</html>
